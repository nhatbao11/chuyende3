<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lịch Sử Giao Dịch</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f8fafc; font-family: 'Segoe UI', sans-serif; }
        .main-card { background: white; border-radius: 12px; border: none; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .card-header-custom { padding: 20px 25px; border-bottom: 1px solid #e2e8f0; background: white; border-top-left-radius: 12px; border-top-right-radius: 12px; display: flex; justify-content: space-between; align-items: center; }
        .table-custom th { background-color: #f1f5f9; color: #475569; font-weight: 600; text-transform: uppercase; font-size: 0.8rem; padding: 16px; border-bottom: 2px solid #e2e8f0; }
        .table-custom td { padding: 16px; vertical-align: middle; color: #334155; }
        .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; }
        .status-paid { background-color: #dcfce7; color: #15803d; }
        .status-pending { background-color: #fef9c3; color: #a16207; }
        .campaign-tag { background: #e0e7ff; color: #4338ca; padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .filter-select { border: 2px solid #e2e8f0; border-radius: 8px; padding: 5px 10px; font-weight: 600; color: #475569; outline: none; transition: all 0.2s; }
        
        /* Style mới cho tổng tiền */
        .summary-box { display: flex; gap: 15px; }
        .badge-info-custom { background: #e0f2fe; color: #0369a1; border: 1px solid #bae6fd; font-size: 0.9rem; padding: 8px 15px; border-radius: 8px; }
        .badge-success-custom { background: #dcfce7; color: #15803d; border: 1px solid #bbf7d0; font-size: 0.9rem; padding: 8px 15px; border-radius: 8px; }
    </style>
</head>
<body>

    <nav class="navbar navbar-white bg-white shadow-sm mb-5">
        <div class="container-fluid px-4">
            <span class="navbar-brand fw-bold">
                TRANSACTION HISTORY
            </span>
            <div class="d-flex gap-2">
                <a href="/admin/roi" class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-arrow-left me-1"></i> Dashboard
                </a>
                
                <select id="campaignFilter" class="filter-select" onchange="filterOrders()">
                    <option value="all">Tất cả chiến dịch</option>
                    <% campaigns.forEach(camp => { %>
                        <option value="<%= camp %>"><%= camp %></option>
                    <% }); %>
                </select>
                
                <button onclick="window.location.reload()" class="btn btn-primary btn-sm"><i class="fas fa-sync"></i></button>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-4">
        <div class="main-card">
            <div class="card-header-custom">
                <h5 class="m-0 fw-bold text-dark">Danh Sách Đơn Hàng</h5>
                
                <div class="summary-box">
                    <span class="badge-info-custom">
                        <i class="fas fa-shopping-bag me-1"></i> Tổng: <span id="totalCount" class="fw-bold">0</span> đơn
                    </span>
                    <span class="badge-success-custom">
                        <i class="fas fa-coins me-1"></i> Doanh thu: <span id="totalRevenue" class="fw-bold">0 ₫</span>
                    </span>
                </div>
                </div>
            
            <div class="table-responsive">
                <table class="table table-custom table-hover mb-0">
                    <thead>
                        <tr>
                            <th style="width: 30%">Khách Hàng / Mã Đơn</th>
                            <th style="width: 25%">Chiến Dịch (Source)</th>
                            <th style="width: 20%">Ngày Giao Dịch</th>
                            <th class="text-end" style="width: 15%">Doanh Thu</th>
                            <th class="text-center" style="width: 10%">Trạng Thái</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (orders.length === 0) { %>
                            <tr><td colspan="5" class="text-center py-5 text-muted">Chưa có dữ liệu.</td></tr>
                        <% } else { %>
                            <% orders.forEach(order => { %>
                                <tr class="order-row" data-campaign="<%= order.campaign %>">
                                    <td>
                                        <div class="fw-bold text-dark fs-6"><%= order.customerName %></div>
                                        <div class="small text-muted font-monospace">#<%= order.id.substring(0, 8) %></div>
                                    </td>
                                    <td>
                                        <div class="mb-1"><span class="campaign-tag"><%= order.campaign %></span></div>
                                        <div class="source-text"><i class="fas fa-link me-1"></i> <%= order.source %></div>
                                    </td>
                                    <td>
                                        <div class="text-dark fw-500"><%= order.date.toLocaleDateString('vi-VN') %></div>
                                        <div class="small text-muted"><%= order.date.toLocaleTimeString('vi-VN') %></div>
                                    </td>
                                    
                                    <td class="text-end fw-bold text-dark fs-6 amount-col">
                                        <%= order.amount.toLocaleString('vi-VN') %> ₫
                                    </td>
                                    
                                    <td class="text-center">
                                        <span class="status-badge <%= order.status === 'paid' ? 'status-paid' : 'status-pending' %>">
                                            <%= order.status === 'paid' ? 'Paid' : 'Pending' %>
                                        </span>
                                    </td>
                                </tr>
                            <% }); %>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        function filterOrders() {
            // 1. Lấy giá trị bộ lọc
            const filterValue = document.getElementById('campaignFilter').value;
            const rows = document.querySelectorAll('.order-row');
            
            let visibleCount = 0;
            let currentRevenue = 0; // Biến cộng dồn tiền

            // 2. Duyệt qua từng dòng
            rows.forEach(row => {
                const campaignName = row.getAttribute('data-campaign');
                
                // Kiểm tra điều kiện lọc
                if (filterValue === 'all' || campaignName === filterValue) {
                    row.style.display = ''; // Hiện dòng
                    visibleCount++;

                    // --- LOGIC TÍNH TIỀN ---
                    // Lấy text số tiền (VD: "499.000 ₫")
                    const amountText = row.querySelector('.amount-col').innerText;
                    // Xóa dấu chấm và chữ đ để lấy số (VD: 499000)
                    const amount = parseInt(amountText.replace(/\D/g, ''));
                    // Cộng dồn
                    currentRevenue += amount;
                } else {
                    row.style.display = 'none'; // Ẩn dòng
                }
            });

            // 3. Cập nhật giao diện
            document.getElementById('totalCount').innerText = visibleCount;
            // Format lại tiền sang dạng Tiếng Việt (VD: 499.000 ₫)
            document.getElementById('totalRevenue').innerText = currentRevenue.toLocaleString('vi-VN') + ' ₫';
        }

        // Chạy hàm này 1 lần ngay khi load trang để tính tổng ban đầu
        document.addEventListener('DOMContentLoaded', filterOrders);
    </script>

</body>
</html>
