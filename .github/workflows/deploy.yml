name: Deploy FE + BE (landing-page branch)

on:
  push:
    branches: ["landing-page"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Deploy to Server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "=== Pull repo vào thư mục source-temp ==="
          cd /var/www/source-temp

          git fetch origin
          git reset --hard origin/landing-page

          echo "=== Copy FE vào html ==="
          cp -r /var/www/source-temp/index.html /var/www/html/
          cp -r /var/www/source-temp/assets /var/www/html/ 2>/dev/null || true

          echo "=== Copy BE vào /var/www/be ==="
          cp -r /var/www/source-temp/landingbe.js /var/www/be/
          cp -r /var/www/source-temp/package.json /var/www/be/

          cd /var/www/be
          npm install --production

          echo "=== Restart PM2 ==="
          pm2 restart lp-backend || pm2 start landingbe.js --name lp-backend

          echo "=== Deploy thành công ==="
