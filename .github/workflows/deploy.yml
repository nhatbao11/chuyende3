name: Deploy LP Backend from landing-page branch

on:
  push:
    branches: [ "landing-page" ] 

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    
    # === THÊM KHỐI NÀY ===
    defaults:
      run:
        working-directory: ${{ github.workspace }}
    # =====================
    
    steps:
    # 1. Checkout mã nguồn
    - name: Checkout Code
      uses: actions/checkout@v4
      
    # 2. Thiết lập Node.js
    - name: Set up Node.js Environment
      uses: actions/setup-node@v4
      with:
        node-version: '20' 
    
    # 3. Cài đặt Dependencies
    - name: Install Dependencies
      # Lệnh này bây giờ chắc chắn chạy ở thư mục gốc (nơi có package.json)
      run: npm install

    # --- BƯỚC TRIỂN KHAI (CD) ---
    
    # 4. Thiết lập SSH Agent
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
    # 5. Triển khai lên Server và Khởi động lại dịch vụ
    - name: Deploy and Restart Service
      uses: appleboy/ssh-action@master
      with:
        # Nếu lỗi 'missing server host' (image_166d98.png) vẫn xảy ra,
        # nghĩa là Secret DEPLOY_HOST đang bị trống.
        host: ${{ secrets.DEPLOY_HOST }} 
        username: ${{ secrets.DEPLOY_USER }}
        script: |
          echo "Starting deployment on server..."
          # Chuyển đến thư mục dự án
          cd ${{ secrets.DEPLOY_PATH }}
          
          # Lấy mã mới nhất từ nhánh landing-page
          git pull origin landing-page 
          
          # Cài đặt lại dependencies
          npm install
          
          # Khởi động lại dịch vụ Node.js
          pm2 restart lp-backend || pm2 start landingbe.js --name lp-backend
          
          echo "Deployment finished and service restarted."