name: Deploy LP Backend from lp-backend branch

# Kích hoạt Workflow khi có push lên nhánh 'lp-backend'
on:
  push:
    branches: [ "lp-backend" ]

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Checkout mã nguồn
    - name: Checkout Code
      uses: actions/checkout@v4
      
    # 2. Thiết lập Node.js
    - name: Set up Node.js Environment
      uses: actions/setup-node@v4
      with:
        # Đảm bảo phiên bản Node này khớp với phiên bản trên VPS của bạn
        node-version: '20' 
    
    # 3. Cài đặt Dependencies (chạy npm install trên máy ảo GitHub)
    - name: Install Dependencies
      run: npm install

    # --- BƯỚC TRIỂN KHAI (CD) ---
    
    # 4. Thiết lập SSH Agent để sử dụng Private Key
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        # Sử dụng Secret Key đã lưu trữ
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
    # 5. Triển khai lên Server và Khởi động lại dịch vụ
    - name: Deploy and Restart Service
      # Sử dụng Action để chạy lệnh SSH từ xa
      uses: appleboy/ssh-action@master
      with:
        # Sử dụng các Secrets đã lưu trữ
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        # Lệnh chạy trên VPS
        script: |
          echo "Starting deployment on server..."
          # Chuyển đến thư mục dự án
          cd ${{ secrets.DEPLOY_PATH }}
          
          # Lấy mã mới nhất từ nhánh lp-backend
          git pull origin lp-backend
          
          # Cài đặt lại dependencies (nếu có thay đổi trong package.json)
          npm install
          
          # Khởi động lại dịch vụ Node.js
          # Giả định bạn đang dùng PM2 với tên 'lp-backend'
          pm2 restart lp-backend || pm2 start landingbe.js --name lp-backend
          
          echo "Deployment finished and service restarted."