<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bàn phím cơ X Pro – Ưu đãi đặc biệt</title>

  <style>
    @keyframes floaty{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
    @keyframes gradientMove{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}

    :root {
      --bg: #000000;
      --fg: #eaeaea;
      --accent: #8cd3ff;
      --muted: #9ca3af;
    }

    *{box-sizing:border-box}
    html,body{
      height:100%; margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto;
      background:#000;
      color:var(--fg);
    }

    /* Background ánh sáng */
    .bg-aurora{
      position:fixed; inset:-20vmax; z-index:-1;
      background:radial-gradient(800px 600px at 60% 20%,rgba(140,211,255,0.25),rgba(0,0,0,0));
      filter:blur(80px); opacity:.45;
      animation:gradientMove 10s ease infinite;
    }

    .wrap{max-width:1100px;margin:0 auto;padding:28px}

    /* Hero */
    .hero{
      display:grid; gap:22px; margin:40px 0; padding:30px;
      border-radius:26px;
      background:rgba(255,255,255,0.03);
      border:1px solid rgba(255,255,255,0.06);
      backdrop-filter:blur(12px);
    }

    h1{font-size:clamp(32px,3.5vw,52px);margin:0;font-weight:700;}
    .sub{color:var(--muted);font-size:17px;line-height:1.6}

    .cta{
      display:inline-flex;align-items:center;gap:10px;
      background:var(--accent);color:#000;
      padding:14px 22px;border-radius:14px;
      font-size:17px;font-weight:700;
      text-decoration:none;border:none;cursor:pointer;
      transition:transform .12s ease;
    }
    .cta:hover{transform:translateY(-2px)}

    /* Form */
    .card{
      background:rgba(255,255,255,0.02);
      border:1px solid rgba(255,255,255,0.05);
      border-radius:20px;padding:26px;
    }

    input[type=text],input[type=email]{
      width:100%;padding:12px 14px;
      background:#0b0b0b;
      border:1px solid #2a2a2a;
      border-radius:12px;color:var(--fg);
      outline:none;
    }

    input[type=text]:focus,input[type=email]:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 3px rgba(140,211,255,0.15);
    }

    label{font-size:15px;color:var(--muted);}

    .illus img{
      width:330px; max-width:90%;
      animation:floaty 6s ease-in-out infinite;
      filter:drop-shadow(0 20px 50px rgba(140,211,255,0.25));
    }

    .ok{color:#4ade80;}
    .err{color:#f87171;}

    pre.jsonbox{
      background:#0a0a0a;
      color:#8cd3ff;
      font-size:13px;
      padding:10px 12px;border-radius:10px;
      border:1px solid #1f1f1f;
      white-space:pre-wrap;
      word-break:break-all;
    }
  </style>
</head>

<body>
  <div class="bg-aurora"></div>

  <div class="wrap">
    <header class="hero">
      <div class="pill" style="font-size:14px;color:var(--muted);">Ưu Đãi • Bàn phím cơ cao cấp</div>

      <h1>Bàn phím cơ X Pro – Cơ hội nhận ngay<br/>Ưu Đãi Độc Quyền 50%</h1>
      <p class="sub">Nhập thông tin để giữ suất ưu đãi cho Bàn phím cơ X Pro – số lượng giới hạn.</p>

      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:28px">
        <div class="illus">
          <img src="https://img4.thuthuatphanmem.vn/uploads/2020/12/26/anh-ban-phim-co-dep_033839277.jpg" alt="Bàn phím cơ X Pro" />
        </div>
      </div>
    </header>

    <section>
      <div class="card">
        <h2>Đăng ký giữ ưu đãi</h2>

        <form id="leadForm" class="row" autocomplete="on">
          <div>
            <label>Họ và tên</label>
            <input id="name" name="name" type="text" placeholder="Nguyễn Văn A" />
          </div>

          <div>
            <label>Email <span class="muted">(bắt buộc)</span></label>
            <input id="email" name="email" type="email" required placeholder="ban@vidu.com" />
          </div>

          <div>
            <label>
              <input id="consent" type="checkbox"/>
              Tôi đồng ý nhận thông tin ưu đãi & cập nhật về Bàn phím cơ X Pro.
            </label>
          </div>

          <input type="hidden" name="client_id" id="client_id" />
          <input type="hidden" name="session_id" id="session_id" />
          <input type="hidden" name="referrer" id="referrer" />
          <input type="hidden" name="user_agent" id="user_agent" />

          <div style="display:flex;gap:12px;align-items:center;margin-top:12px">
            <button id="submitBtn" class="cta" type="submit">Giữ ưu đãi</button>
            <small id="status" class="muted"></small>
          </div>

          <pre id="jsonDebug" class="jsonbox" style="display:none"></pre>
        </form>
      </div>
    </section>

    <footer style="margin:40px 0;opacity:.8;text-align:center">
      <small class="muted">© 2025 Bàn phím cơ X Pro Pre-order Landing Page</small>
    </footer>
  </div>

<script>
/* ======================== CONFIG ======================== */
const CONFIG = { 
    LEADS_ENDPOINT: "http://103.75.183.194:5678/webhook/lp-leads",
    // Vẫn giữ nguyên địa chỉ backend, không thay đổi chức năng
    TRAFFIC_ENDPOINT: "http://103.75.183.194:8080/traffic/log" 
};

/* ======================== HELPERS (Sửa đổi) ======================== */
const $ = (id)=>document.getElementById(id);
const safe = (s)=>String(s??'').replace(/</g,'&lt;');

// Hàm mới: Đọc tham số URL
const getUrlParam = (name) => new URLSearchParams(window.location.search).get(name);


/* ======================== TRAFFIC LOGGING (COUNT BY CAMPAIGN) ======================== */
const logTraffic = async () => {
    if (!CONFIG.TRAFFIC_ENDPOINT) return;

    // Lấy giá trị utm_campaign từ URL
    const campaignName = getUrlParam('utm_campaign') || ''; 

    if (campaignName === '') {
        console.log('No utm_campaign found, skipping traffic log.');
        return; // KHÔNG LOG nếu không có campaign
    }

    try {
        await fetch(CONFIG.TRAFFIC_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ campaign_name: campaignName }) // <-- GỬI TÊN CAMPAIGN
        });
    } catch (e) {
        console.warn('Could not log traffic:', e);
    }
};

/* ======================== SUBMIT FORM (Giữ nguyên) ======================== */
const form = document.getElementById('leadForm');

form.addEventListener('submit', async (e)=>{
  e.preventDefault();

  const statusEl = $("status");
  statusEl.textContent = "Đang gửi...";
  $("submitBtn").disabled = true;

  const data = Object.fromEntries(new FormData(form).entries());

  if(!data.email){
    statusEl.textContent="Vui lòng nhập email";
    $("submitBtn").disabled = false;
    return;
  }

  try{
    // *** Cần lấy UTM từ URL và gửi kèm nếu cần, nhưng hiện tại BE tự fake/lấy UTM từ query ***
    const res = await fetch(CONFIG.LEADS_ENDPOINT, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        ...data,
        consent: document.getElementById('consent').checked,
        source_lp: location.hostname
      })
    });

    let j = {};
    try { j = await res.json(); } catch(_){}

    const msg = j.message || j.reason || "";

    if (j.status === 'ok') {
      statusEl.innerHTML = '<span class="ok">Đăng ký thành công!</span>';
      form.reset();
    }
    else if (j.status === 'error' && msg) {
      statusEl.innerHTML = `<span class="err">${safe(msg)}</span>`;
    }
    else if (res.ok && (res.status === 204 || Object.keys(j).length === 0)) {
      statusEl.innerHTML = '<span class="ok">Đăng ký thành công!</span>';
      form.reset();
    }
    else {
      statusEl.innerHTML = '<span class="err">Có lỗi xảy ra, thử lại sau.</span>';
    }

  }catch(err){
    statusEl.innerHTML = '<span class="err">Không thể kết nối máy chủ.</span>';
  }finally{
    $("submitBtn").disabled = false;
  }
});

/* ======================== RUN ON LOAD ======================== */
document.addEventListener('DOMContentLoaded', () => {
    // Gọi hàm đếm lượt truy cập khi trang tải xong
    logTraffic(); 
});
</script>

</body>
</html>